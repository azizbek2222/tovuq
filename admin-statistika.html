<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chicken Farm - Admin Control Panel</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; margin: 0; }
        .container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #0088cc; margin-bottom: 25px; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }
        
        /* Statistika qismi */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .stat-card { background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center; border-left: 5px solid #0088cc; }
        .stat-card span { display: block; font-size: 13px; color: #666; text-transform: uppercase; }
        .stat-card strong { font-size: 22px; color: #333; }

        /* Qidiruv va Jadval */
        .search-bar { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #0088cc; color: white; position: sticky; top: 0; }
        tr:hover { background: #f1f8ff; }

        /* Statuslar */
        #loading-overlay { text-align: center; padding: 40px; color: #888; }
        .error-msg { color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        
        .badge { padding: 5px 10px; border-radius: 6px; font-weight: bold; font-size: 12px; }
        .bg-money { background: #e8f5e9; color: #2e7d32; }
        .bg-bird { background: #fff3e0; color: #ef6c00; }
        .bg-user { background: #e3f2fd; color: #0d47a1; }
    </style>
</head>
<body>

<div class="container">
    <h2>Admin Dashboard</h2>

    <div id="error-box" class="error-msg"></div>

    <div class="stats-grid">
        <div class="stat-card">
            <span>Foydalanuvchilar</span>
            <strong id="total-users">0</strong>
        </div>
        <div class="stat-card">
            <span>Umumiy Balans</span>
            <strong id="total-balance">0.00000</strong>
        </div>
        <div class="stat-card">
            <span>Jami Tovuqlar</span>
            <strong id="total-chickens">0</strong>
        </div>
    </div>

    <input type="text" id="searchInput" class="search-bar" placeholder="Telegram ID orqali qidirish...">

    <div id="loading-overlay">
        <p>üîÑ Ma'lumotlar Firebase bazasidan yuklanmoqda...</p>
    </div>

    <div class="table-wrapper">
        <table id="mainTable" style="display: none;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Balans (USDT)</th>
                    <th>Tovuqlar</th>
                    <th>Referallar</th>
                    <th>Sana</th>
                </tr>
            </thead>
            <tbody id="userRows"></tbody>
        </table>
    </div>
</div>

<script type="module">
    // Fayl yo'li to'g'riligini tekshiring!
    import { db, ref, get } from './firebase.js';

    async function fetchData() {
        const loading = document.getElementById('loading-overlay');
        const errorBox = document.getElementById('error-box');
        const table = document.getElementById('mainTable');
        const tbody = document.getElementById('userRows');

        try {
            console.log("Firebase so'rovi yuborilmoqda...");
            const usersRef = ref(db, 'users');
            const snapshot = await get(usersRef);

            if (!snapshot.exists()) {
                loading.innerHTML = "‚ö†Ô∏è Bazada 'users' bo'limi topilmadi yoki bo'sh.";
                return;
            }

            const allUsers = snapshot.val();
            let summary = { users: 0, balance: 0, chickens: 0 };
            tbody.innerHTML = '';

            Object.entries(allUsers).forEach(([id, data]) => {
                const balance = parseFloat(data.balance || 0);
                const chickens = data.chickens_list ? data.chickens_list.length : 0;
                const refs = data.referrals_count || 0;
                const regDate = data.created_at ? new Date(data.created_at).toLocaleDateString() : '---';

                summary.users++;
                summary.balance += balance;
                summary.chickens += chickens;

                const row = `
                    <tr>
                        <td><code>${id}</code></td>
                        <td><span class="badge bg-money">${balance.toFixed(5)}</span></td>
                        <td><span class="badge bg-bird">üêî ${chickens}</span></td>
                        <td><span class="badge bg-user">üë• ${refs}</span></td>
                        <td style="color: #999;">${regDate}</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            // Statistika yangilash
            document.getElementById('total-users').innerText = summary.users;
            document.getElementById('total-balance').innerText = summary.balance.toFixed(5);
            document.getElementById('total-chickens').innerText = summary.chickens;

            loading.style.display = 'none';
            table.style.display = 'table';
            console.log("Yuklash muvaffaqiyatli yakunlandi.");

        } catch (err) {
            console.error("XATOLIK:", err);
            loading.style.display = 'none';
            errorBox.style.display = 'block';
            errorBox.innerHTML = `<strong>Xatolik:</strong> ${err.message}<br><small>Firebase Rules yoki Internet aloqasini tekshiring.</small>`;
        }
    }

    // Qidiruv tizimi
    document.getElementById('searchInput').addEventListener('keyup', function() {
        const val = this.value.toLowerCase();
        const rows = document.querySelectorAll('#userRows tr');
        rows.forEach(row => {
            const id = row.querySelector('td').innerText.toLowerCase();
            row.style.display = id.includes(val) ? '' : 'none';
        });
    });

    fetchData();
</script>

</body>
</html>